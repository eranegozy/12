<!DOCTYPE html>
<html>
<head>
  <title>Mobile Instrument</title>
  <meta name="viewport" content="initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,width=device-width,height=device-height,user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script type="text/javascript" src="p5.js">      </script>
  <script type="text/javascript" src="p5.dom.js">  </script>
  <script type="text/javascript" src="eeutils.js"> </script>
  <script type="text/javascript" src="p5.ui.js">   </script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    form, input, button, option, select {
      font-size: 32px;
    }
  </style>
</head>

<body>
  <!-- Page 1: Enter Name Form -->
  <div id="page1" style="display:none">
    <h1>Mobile Instrument</h1>
    <form id="form1" onsubmit="setName(this.name.value); return false;">
      Enter Your Name: <input type="text" id="name" autocomplete="off">
      <input type="submit" value="Next">
    </form>
  </div>

  <!-- Page 2: Enter Section -->
  <div id="page2" style="display:none">
    <h1>Mobile Instrument</h1>
    <select class="selectClass" id="ddlSection" onchange="setSection(this.value)">
      <option value="null">Pick a Section</option>
    </select>

    <br>
    <button type="button" onclick="gotoPage(1)">Back</button>
    <br>
    <button type="button" onclick="if(gPlayerData.sectionIdx != null) gotoPage(3)">Next</button>
  </div>

  <!-- Page 3: Live Display of Instrument / Status -->
  <div id="page3" style="display:none">
<!--     <p id="displayName"></p>
    <p id="displaySection"></p>
    <p id="instEnabled"></p>
    <button type="button" onclick="gotoPage(2)">Back</button>
    <hr>
    <div id="inst_control"></div>
 -->  
  </div>

  <hr>
  <p id="output"><b>Output:</b><br></p>

  <script>
    utl.init(null);
    // utl.init('console');
    // utl.init('output');
    utl.print(location.host);
    var gSocket = io(location.host + '/player');
    var gPlayerData = {};
    var gSongData;
    var gCondData;

    var gP5Enabled = false;
    var gInstEnabled = false;

    var gDevID = utl.getCookie("devID");
    if (gDevID == '')
    {
      gDevID = Math.random();
      utl.print("no cookie found. Creating:" + gDevID);
      utl.setCookie("devID", gDevID, 1);
    }
    else
    {
      utl.print("cookie found:" + gDevID);
    }

    // message handling:
    gSocket.on('allData', function(data) {
      utl.print("allData:" + JSON.stringify(data));
      gPlayerData = data[0];
      gSongData = data[1];
      gCondData = data[2];

      updateSectionPickerDisplay();
      updatePlayerDisplay();
      updateInstrumentDisplay();
      updateInstrumentEnabledDisplay();
    });

    gSocket.on('playerData', function(data) {
      utl.print("received playerData:" + JSON.stringify(data));
      gPlayerData = data;

      updatePlayerDisplay();
      updateInstrumentDisplay();
      updateInstrumentEnabledDisplay();
    });

    gSocket.on('songData', function(data) {
      utl.print("received songData:" + JSON.stringify(data));
      gSongData = data;

      updateSectionPickerDisplay();
      updatePlayerDisplay();
      updateInstrumentDisplay();
    });

    gSocket.on('condData', function(data) {
      utl.print("received condData:" + JSON.stringify(data));
      gCondData = data;

      updateInstrumentEnabledDisplay();
    });

    var gCurPage = 0;
    var gotoPage = function(p)
    {
      utl.print('gotoPage:' + p);
      pageTransition(gCurPage, p);
      if (gCurPage)
        document.getElementById('page' + gCurPage).style.display='none';
      gCurPage = p;
      document.getElementById('page' + gCurPage).style.display='';
    }

    var pageTransition = function (fromPage, toPage) {
      if (toPage == 3) {
        window.scrollTo(0, 0);
        gP5Enabled = true;
      }

      if (fromPage == 3)
        gP5Enabled = false;
    }


    var setName = function(val)
    {
      if (!val)
        return;
      utl.print("setName: " + val);

      // send name choice to server:
      gSocket.emit('set', ['name', val]);

      gotoPage(2);
    }

    var setSection = function(val)
    {
      utl.print("setSection:" + val);
      var sec = val;
      if (sec != null) sec = parseInt(val);
      // send name choice to server:
      gSocket.emit('set', ['sectionIdx', sec]);
    }

    var updateSectionPickerDisplay = function()
    {
      // update section drop-drown list
      var x = document.getElementById("ddlSection");
      // remove all but the first one (which is the title of the selection UI):
      while(x.options.length > 1)
        x.remove(1);

      // add the sections.
      for(var i=0; i < gSongData.sections.length; ++i)
      {
        var option = document.createElement("option");
        option.text = gSongData.sections[i].name;
        option.value = i;
        x.add(option, x.options.length);
      }
    }

    var updatePlayerDisplay = function()
    {
      gPlayerNameTxt = gPlayerData.name;
      if (gPlayerData.sectionIdx != null) 
        gSectionNameTxt = gSongData.sections[gPlayerData.sectionIdx].name;
      else
        gSectionNameTxt = '';
    }

    var gInstWidgets = [];
    var updateInstrumentDisplay = function()
    {
      // check if an instrument is selected...
      if (gPlayerData.sectionIdx == null || gPlayerData.instIdx == null)
        return;

      // now, configure the new inst
      var inst = gSongData.sections[gPlayerData.sectionIdx].instruments[gPlayerData.instIdx];
      utl.print("configing" + JSON.stringify(inst));

      gInstNameTxt = inst.name;

      // clear out existing UI elements
      for (var i = 0; i < gInstWidgets.length; i++) {
        ui.removeWidget(gInstWidgets[i]);
      };
      gInstWidgets = [];

      // create new UI elements
      switch(inst.type)
      {
        case 'buttons':
        createButtonsControl(inst);
        break;

        case '1d':
        create1DControl(inst);
        break;

        case '2d':
        create2DControl(inst);
        break;
      }
    }

    var createButtonsControl = function(inst)
    {
      var xLen = width;
      var buttonsPerRow = 2;
      var y0 = 100, dy = 150;
      var butSize = 50;      
      if (inst.size == 1) {
        buttonsPerRow = 1;
        butSize = 100;
        y0 = 200;
      }

      for(var i=0; i < inst.size; ++i) {
        var col = i % buttonsPerRow;
        var x = (1+col) * xLen / (1+buttonsPerRow);
        var row = Math.floor(i/buttonsPerRow);
        var y = y0 + (row * dy);
        var btn = new ui.Button(i+1, x, y, butSize, [200, 50, 50], buttonControlCB);
        gInstWidgets.push(btn);
      }
    }

    var buttonControlCB = function(id, val) { 
      if (val == 'down')
        gSocket.emit('ctrl', [gPlayerData.instIdx, 'btn', id]);
    }

    var create1DControl = function(inst)
    {
      var len = height - 200;
      var y = 100;
      for(var i=0; i < inst.size; ++i) {
        var x = (i+1) * width / (inst.size + 1);
        var slider = new ui.Slider(i+1, x, y, len, [200, 50, 50], sliderControlCB);
        gInstWidgets.push(slider);
      }
    }

    var sliderControlCB = function(id, val) {
       if (val == 'down')
         gSocket.emit('ctrl', [gPlayerData.instIdx, 'play', id]);
       else if (val == 'up')
         gSocket.emit('ctrl', [gPlayerData.instIdx, 'play', 0]);
       else
         gSocket.emit('ctrl', [gPlayerData.instIdx, 'speed', 0.5 + val]);
    }

    var create2DControl = function(inst)
    {

    }

    var updateInstrumentEnabledDisplay = function()
    {
      // update if the instrument is enabled now based on what section we are in.
      gInstEnabled = gPlayerData.sectionIdx == gCondData.sectionIdx;
      for (var i = 0; i < gInstWidgets.length; i++) {
        gInstWidgets[i].enabled = gInstEnabled;
      };
    }


  var gPlayerNameTxt = 'player name';
  var gInstNameTxt = 'instrument';
  var gSectionNameTxt = 'section';

  setup = function () {
    // var cnv = createCanvas(displayWidth, displayHeight);
    var cnv = createCanvas(windowWidth, windowHeight);
    cnv.parent('page3');

    var btn2 = new ui.Button('back', width-50, height-50, 40, [50, 100, 250], function(n, v) {
      if (v=='up') gotoPage(2); } );

  };

  touchStarted = function() {
    utl.print('touchStarted1 ' + touchX + ' ' + touchY);
    if (!gP5Enabled)
      return true;

    utl.print('touchStarted2 ' + touchX + ' ' + touchY);

    if (utl.supportsTouch())
      ui.down(touchX, touchY);
    else
      ui.down(mouseX, mouseY);
    return false;
  }

  touchEnded = function() {
    if (!gP5Enabled)
      return true;

    if (utl.supportsTouch())
      ui.up(touchX, touchY);
    else
      ui.up(mouseX, mouseY);
    return false;
  }

  draw = function() {
    if (!gP5Enabled)
      return;

    background(255);

    // player name
    strokeWeight(0);
    stroke(0);
    fill(0);
    textAlign(LEFT);
    textSize(20);
    text(gPlayerNameTxt, 10, height - 25);
    
    // section and instrument names
    if (!gInstEnabled) {
      stroke(150);
      fill(150);
    }
    textAlign(CENTER);
    textSize(32);
    text(gSectionNameTxt + ': ' + gInstNameTxt, width/2, 30);

    // ui draw
    if (utl.supportsTouch())
      ui.draw(touchX, touchY);
    else
      ui.draw(mouseX, mouseY);
  }

  function btnCB(name, value) {
    utl.print('button ' + name + ': ' + value);
  }

    gotoPage(1);

  </script>
</body>
</html> 
