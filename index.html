<!DOCTYPE html>
<html>
<head>
   <title>12 Mobile Player</title>
   <meta name="viewport" content="initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,width=device-width,height=device-height,user-scalable=no">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <script src="eeutils.js" type="text/javascript"></script>
   <script src="/socket.io/socket.io.js"></script>
</head>

<body onload='eeutils.init("output");'>

   <h1>OSC Mobile Player</h1>


   <!-- Page 1: Enter Name Form -->
   <div id="page1" style="display:none">
      <form id="form1" onsubmit="setName(this.name.value); return false;">
         Enter Your Name: <input type="text" id="name" autocomplete="off">
        <input type="submit" value="Next">
      </form>
   </div>

   <!-- Page 2: Enter Section -->
   <div id="page2" style="display:none">
      <select id="ddlSection" onchange="setSection(this.value)">
         <option value="null">Pick a Section</option>
      </select>

      <br>
      <button type="button" onclick="gotoPage(1)">Back</button>
      <br>
      <button type="button" onclick="if(gPlayerData.sectionIdx != null) gotoPage(3)">Next</button>
   </div>

   <!-- Page 3: Live Display of Instrument / Status -->
   <div id="page3" style="display:none">
      <p id="displayName"></p>
      <p id="displaySection"></p>
      <p id="instEnabled"></p>
      <button type="button" onclick="gotoPage(2)">Back</button>
      <hr>

      <div id="inst_buttons" style="display:none">
         <h2>Buttons Instrument</h2>
         <button class="inst" type="button" onclick="control(1)">Control 1</button>
         <button class="inst" type="button" onclick="control(2)">Control 2</button>
         <button class="inst" type="button" onclick="control(3)">Control 3</button>
      </div>

      <div id="inst_1d" style="display:none">
         <h2>1D Slider Instrument</h2>
         <input id="slider1" type="range" min="0" max="500">Slider1</input>
      </div>

      <div id="inst_2d" style="display:none">
         <h2>2D Instrument</h2>
      </div>

   </div>

   <hr>
   <p id="output"><b>Output:</b><br></p>

   <script>
      eeutils.print(location.host);
      var gSocket = io(location.host + '/player');
      var gPlayerData = {};
      var gSongData;
      var gCondData;

      var gDevID = getCookie("devID");
      if (gDevID == '')
      {
         gDevID = Math.random();
         eeutils.print("no cookie found. Creating:" + gDevID);
         setCookie("devID", gDevID, 1);
      }
      else
      {
         eeutils.print("cookie found:" + gDevID);
      }

      // message handling:
      gSocket.on('allData', function(data) {
         eeutils.print("allData:" + JSON.stringify(data));
         gPlayerData = data[0];
         gSongData = data[1];
         gCondData = data[2];

         updateSectionPickerDisplay();
         updatePlayerDisplay();
         updateInstrumentDisplay();
         updateInstrumentEnabledDisplay();
      });

      gSocket.on('playerData', function(data) {
         eeutils.print("received playerData:" + JSON.stringify(data));
         gPlayerData = data;

         updatePlayerDisplay();
         updateInstrumentDisplay();
         updateInstrumentEnabledDisplay();
      });

      gSocket.on('songData', function(data) {
         eeutils.print("received songData:" + JSON.stringify(data));
         gSongData = data;

         updateSectionPickerDisplay();
         updatePlayerDisplay();
         updateInstrumentDisplay();
      });

      gSocket.on('condData', function(data) {
         eeutils.print("received condData:" + JSON.stringify(data));
         gCondData = data;

         updateInstrumentEnabledDisplay();
      });

      var gCurPage = 0;
      var gotoPage = function(p)
      {
         if (gCurPage)
            document.getElementById('page' + gCurPage).style.display='none';
         gCurPage = p;
         document.getElementById('page' + gCurPage).style.display='';
      }

      var setName = function(val)
      {
         if (!val)
            return;
         eeutils.print("setName: " + val);

         // send name choice to server:
         gSocket.emit('set', ['name', val]);

         gotoPage(2);
      }

      var setSection = function(val)
      {
         eeutils.print("setSection:" + val);
         var sec = val;
         if (sec != null) sec = parseInt(val);
         // send name choice to server:
         gSocket.emit('set', ['sectionIdx', sec]);
      }

      // var control = function(i)
      // {
      //    eeutils.print("sending control");
      //    gSocket.emit('control', i);
      // }

      var updateSectionPickerDisplay = function()
      {
         // update section drop-drown list
         var x = document.getElementById("ddlSection");
         // remove all but the first one (which is the title of the selection UI):
         while(x.options.length > 1)
            x.remove(1);

         // add the sections.
         for(var i=0; i < gSongData.sections.length; ++i)
         {
            var option = document.createElement("option");
            option.text = gSongData.sections[i].name;
            option.value = i;
            x.add(option, x.options.length);
         }
      }

      var updatePlayerDisplay = function()
      {
         // display name and section from gPlayerData
         document.getElementById("displayName").innerHTML = 'Name: ' + gPlayerData.name;
         if (gPlayerData.sectionIdx != null) 
         {
            var name = gSongData.sections[gPlayerData.sectionIdx].name;
            document.getElementById("displaySection").innerHTML = 'Your Section: ' + name;
         }
      }

      var gCurInst;
      var updateInstrumentDisplay = function()
      {
         // first, hide the old inst:
         if (gCurInst)
            document.getElementById('inst_' + gCurInst).style.display='none';

         // check if an instrument is selected...
         if (gPlayerData.sectionIdx == null || gPlayerData.instIdx == null)
            return;

         // now, show the new inst
         var inst = gSongData.sections[gPlayerData.sectionIdx].instruments[gPlayerData.instIdx];
         eeutils.print("configing" + JSON.stringify(inst));
         
         gCurInst = inst.type;
         document.getElementById('inst_' + gCurInst).style.display='';

         switch(inst.type)
         {
            case 'buttons':
            break;

            case '1d':
            break;

            case '2d':
            break;
         }
      }

      var updateInstrumentEnabledDisplay = function()
      {
         // update if the instrument is enabled now based on what section we are in.
         var enabled = gPlayerData.sectionIdx == gCondData.sectionIdx;
         var txt =  enabled ? "ENABLED" : "OFF";
         document.getElementById("instEnabled").innerHTML = "Instrument Status: " + txt;

         // enable / disable buttons:
         var disabled_txt = enabled ? "" : "disabled";
         var elems = document.getElementsByClassName("inst");
         for (var i = 0; i < elems.length; i++) {
            elems[i].disabled = disabled_txt;
         };
      }

      gotoPage(1);

   </script>
</body>
</html> 
