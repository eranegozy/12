<!DOCTYPE html>
<html>
<head>
  <title>Mobile Instrument</title>
  <meta name="viewport" content="initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script type="text/javascript" src="p5.js">      </script>
  <script type="text/javascript" src="p5.dom.js">  </script>
  <script type="text/javascript" src="eeutils.js"> </script>
  <script type="text/javascript" src="p5.ui.js">   </script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    form, input, button, option, select {
      font-size: 32px;
    }

    div, body {
      padding: 0; 
      margin: 0;
    }

  </style>
</head>

<body>
  <!-- Page 1: Enter Name Form -->
  <div id="page1" style="display:none">
    <h1>Mobile Instrument</h1>
    <form id="form1" onsubmit="setName(this.input_name.value); return false;">
      Enter Your Name: <input type="text" id="input_name" autocomplete="off">
      <input type="submit" value="Next">
    </form>
  </div>

  <!-- Page 2: Choose Section -->
  <div id="page2" style="display:none">
    <h1>Mobile Instrument</h1>
    Pick a Section:<br>
    <form id='sectionSelect'>
    </form>

    <br>
    <button type="button" onclick="if(gPlayerData.sectionIdx != null) gotoPage(3)">Next</button>
    <br>
    <button type="button" onclick="gotoPage(1)">Back</button>
  </div>

  <!-- Page 3: Choose Instrument -->
  <div id="page3" style="display:none">
    <h1>Mobile Instrument</h1>
    Pick an Instrument:<br>
    <form id='instSelect'>
    </form>

    <br>
    <button type="button" onclick="if(gPlayerData.instIdx != null) gotoPage(4)">Next</button>
    <br>
    <button type="button" onclick="gotoPage(2)">Back</button>
  </div>

  <!-- Page 3: Live Display of Instrument / Status -->
  <div id="page4" style="display:none">
<!-- 
    <p id="displayName"></p>
    <p id="displaySection"></p>
    <p id="instEnabled"></p>
    <button type="button" onclick="gotoPage(2)">Back</button>
    <hr>
    <div id="inst_control"></div>
 -->  
  </div>

<!--   <hr>
  <p id="output"><b>Output:</b><br></p>
 -->
  <script>
  
  utl.init(null);
  // utl.init('console');
  // utl.init('output');
  utl.print(location.host);
  var gSocket = io(location.host + '/player');
  var gPlayerData = {};
  var gSongData;
  var gCondData;

  var gP5Enabled = false;
  var gInstEnabled = false;

  var gDevID = utl.getCookie("devID");
  if (gDevID == '')
  {
    gDevID = Math.random();
    utl.print("no cookie found. Creating:" + gDevID);
    utl.setCookie("devID", gDevID, 1);
  }
  else
  {
    utl.print("cookie found:" + gDevID);
  }

  gSocket.emit('hello', gDevID);


  // message handling:
  gSocket.on('allData', function(data) {
    utl.print("allData:" + JSON.stringify(data));
    gPlayerData = data[0];
    gSongData = data[1];
    gCondData = data[2];

    updateSectionPickerDisplay();
    updateInstPickerDisplay();
    updatePlayerDisplay();
    updateInstrumentDisplay();
    updateInstrumentEnabledDisplay();
  });

  gSocket.on('playerData', function(data) {
    utl.print("received playerData:" + JSON.stringify(data));
    gPlayerData = data;

    updateSectionPickerDisplay();
    updateInstPickerDisplay();
    updatePlayerDisplay();
    updateInstrumentDisplay();
    updateInstrumentEnabledDisplay();
  });

  gSocket.on('songData', function(data) {
    utl.print("received songData:" + JSON.stringify(data));
    gSongData = data;

    updateSectionPickerDisplay();
    updateInstPickerDisplay();
    updatePlayerDisplay();
    updateInstrumentDisplay();
  });

  gSocket.on('condData', function(data) {
    utl.print("received condData:" + JSON.stringify(data));
    gCondData = data;

    updateInstrumentEnabledDisplay();
  });

  var gCurPage = 0;
  var gotoPage = function(p)
  {
    utl.print('gotoPage:' + p);
    pageTransition(gCurPage, p);
    if (gCurPage)
      document.getElementById('page' + gCurPage).style.display='none';
    gCurPage = p;
    document.getElementById('page' + gCurPage).style.display='';
  }

  var pageTransition = function (fromPage, toPage) {
    if (toPage == 4) {
      window.scrollTo(0, 0);
      gP5Enabled = true;
    }

    if (fromPage == 4)
      gP5Enabled = false;
  }

  var setName = function(val)
  {
    if (!val)
      return;
    utl.print("setName: " + val);

    // send name choice to server:
    gSocket.emit('set', ['name', val]);

    gotoPage(2);
  }


  var updateSectionPickerDisplay = function()
  {
    // console.log('updateSectionPickerDisplay')
    var parent = document.getElementById("sectionSelect");
    while(parent.childNodes.length > 0)
      parent.removeChild(parent.childNodes[0]);


    var buttonFunc = function(b) { return function() {
      gSocket.emit('set', ['sectionIdx', b]); } };

    // add a radio button per section.
    var sections = gSongData.sections;
    for(var i=0; i < sections.length; ++i)
    {
      var element = document.createElement("input");
      element.type = 'radio';
      element.value = i;
      element.name = 'section';
      element.onclick = buttonFunc(i);
      if (i == gPlayerData.sectionIdx)
        element.checked = true;

      parent.appendChild(element);

      element = document.createElement("label");
      element.innerHTML = sections[i].name;
      parent.appendChild(element);

      element = document.createElement("br");
      parent.appendChild(element);
    }
  }

  var getInstStatusText = function(instIdx) {
    // TODO finish this, but it needs access to all other instrument data...
    return '';
  }


  var updateInstPickerDisplay = function()
  {
    // console.log('updateInstPickerDisplay')

    if (gPlayerData.sectionIdx == null)
      return;

    // remove old options
    var parent = document.getElementById("instSelect");
    while(parent.childNodes.length > 0)
      parent.removeChild(parent.childNodes[0]);

    // function to set inst
    var buttonFunc = function(b) { return function() {
      gSocket.emit('set', ['instIdx', b]); } };

    // add a radio button per inst
    var instruments = gSongData.sections[gPlayerData.sectionIdx].instruments;
    for(var i=0; i < instruments.length; ++i)
    {
      var element = document.createElement("input");
      element.type = 'radio';
      element.value = i;
      element.name = 'inst';
      element.onclick = buttonFunc(i);
      if (i == gPlayerData.instIdx)
        element.checked = true;
      parent.appendChild(element);

      element = document.createElement("label");
      element.innerHTML = instruments[i].name + getInstStatusText(i);
      parent.appendChild(element);

      element = document.createElement("br");
      parent.appendChild(element);
    }
  }

  var updatePlayerDisplay = function()
  {
    var elem = document.getElementById("input_name");
    elem.value = gPlayerData.name;

    gPlayerNameTxt = gPlayerData.name;
    if (gPlayerData.sectionIdx != null) 
      gSectionNameTxt = gSongData.sections[gPlayerData.sectionIdx].name;
    else
      gSectionNameTxt = '';
  }

  var gInstWidgets = [];
  var updateInstrumentDisplay = function()
  {
    // check if an instrument is selected...
    if (gPlayerData.sectionIdx == null || gPlayerData.instIdx == null)
      return;

    // now, configure the new inst
    var inst = gSongData.sections[gPlayerData.sectionIdx].instruments[gPlayerData.instIdx];
    utl.print("configing" + JSON.stringify(inst));

    gInstNameTxt = inst.name;

    // clear out existing UI elements
    for (var i = 0; i < gInstWidgets.length; i++) {
      ui.removeWidget(gInstWidgets[i]);
    };
    gInstWidgets = [];

    // create new UI elements
    switch(inst.type)
    {
      case 'surface':
      createSurfaceControl(inst);
      break;

      case 'buttons':
      createButtonsControl(inst);
      break;

      case '1d':
      create1DControl(inst);
      break;

      case '2d':
      create2DControl(inst);
      break;
    }
  }

  var createButtonsControl = function(inst)
  {
    var xLen = width;
    var buttonsPerRow = 2;
    var y0 = 100, dy = 150;
    var butSize = 50;      
    if (inst.size == 1) {
      buttonsPerRow = 1;
      butSize = 100;
      y0 = 200;
    }

    for(var i=0; i < inst.size; ++i) {
      var col = i % buttonsPerRow;
      var x = (1+col) * xLen / (1+buttonsPerRow);
      var row = Math.floor(i/buttonsPerRow);
      var y = y0 + (row * dy);
      var btn = new ui.Button(i+1, x, y, butSize, [200, 50, 50], buttonControlCB);
      gInstWidgets.push(btn);
    }
  }

  var buttonControlCB = function(id, val) { 
    if (val == 'down')
      gSocket.emit('ctrl', [gPlayerData.instIdx, 'btn', id]);
  }

  var create1DControl = function(inst)
  {
    var len = height - 200;
    var y = 100;
    for(var i=0; i < inst.size; ++i) {
      var x = (i+1) * width / (inst.size + 1);
      var slider = new ui.Slider(i+1, x, y, len, [200, 50, 50], sliderControlCB);
      gInstWidgets.push(slider);
    }
  }

  var sliderControlCB = function(id, val) {
     if (val == 'down')
       gSocket.emit('ctrl', [gPlayerData.instIdx, 'play', id]);
     else if (val == 'up')
       gSocket.emit('ctrl', [gPlayerData.instIdx, 'play', 0]);
     else
       gSocket.emit('ctrl', [gPlayerData.instIdx, 'x', 1.0 - val]);
  }

  var create2DControl = function(inst) {
    var grid = new ui.Grid(1, 50, 100, width-100, height-200, [200, 50, 50], gridControlCB);
    gInstWidgets.push(grid);
  }

  var gridControlCB = function(id, val) {
     if (val == 'down')
       gSocket.emit('ctrl', [gPlayerData.instIdx, 'play', 1]);
     else if (val == 'up')
       gSocket.emit('ctrl', [gPlayerData.instIdx, 'play', 0]);
     else {
       gSocket.emit('ctrl', [gPlayerData.instIdx, 'xy', val[0], 1.0 - val[1]]);
     }
  }

  var createSurfaceControl = function(inst) {
    var w = width/inst.size;
    var x = 0;
    for (var i = 0; i < inst.size; i++) {
      var surface = new ui.Surface(i, x, 0, w, height, [200, 50, 50], 
                                    surfaceControlCB );
      gInstWidgets.push(surface);
      x += w;
    };
  }

  var surfaceControlCB = function(id, val) {
     if (val == 'down')
       gSocket.emit('ctrl', [gPlayerData.instIdx, id, 'play']);
     else if (val == 'up')
       gSocket.emit('ctrl', [gPlayerData.instIdx, id, 'stop']);
     else {
       gSocket.emit('ctrl', [gPlayerData.instIdx, id, 'xy', val[0], val[1]]);
     }
  }

  var updateInstrumentEnabledDisplay = function()
  {
    // update if the instrument is enabled now based on what section we are in.
    gInstEnabled = gPlayerData.sectionIdx == gCondData.sectionIdx;
    for (var i = 0; i < gInstWidgets.length; i++) {
      gInstWidgets[i].enabled = gInstEnabled;
    };
  }


  var gPlayerNameTxt = 'player name';
  var gInstNameTxt = 'instrument';
  var gSectionNameTxt = 'section';

  window.onresize = function() {
    var display = checkOrientation();
    // resizeCanvas(display.width, display.height);
    // updateInstrumentDisplay();

  };

  var checkOrientation = function() {
    console.log('window W/H: ' + windowWidth + ' ' + windowHeight);
    console.log('display W/H: ' +  displayWidth + ' ' + displayHeight);
    console.log('window inner: ' + window.innerWidth + ' ' + window.innerHeight);
    var w = window.innerWidth;
    var h = window.innerHeight;
    return {width:w, height:h};
  }

  setup = function () {
    var display = checkOrientation();
    
    var cnv = createCanvas(display.width, display.height);
    cnv.parent('page4');

    // create back button
    var btn2 = new ui.Button('back', width-50, height-50, 40, [50, 100, 250], 
                             function(n, v) { if (v=='up') gotoPage(3); } );

  };

  touchStarted = function() {
    utl.print('touchStarted1 ' + touchX + ' ' + touchY);
    if (!gP5Enabled)
      return true;

    utl.print('touchStarted2 ' + touchX + ' ' + touchY);

    if (utl.supportsTouch())
      ui.down(touchX, touchY);
    else
      ui.down(mouseX, mouseY);
    return false;
  }

  touchEnded = function() {
    if (!gP5Enabled)
      return true;

    if (utl.supportsTouch())
      ui.up(touchX, touchY);
    else
      ui.up(mouseX, mouseY);
    return false;
  }

  draw = function() {
    if (!gP5Enabled)
      return;

    background(255);

    // player name
    strokeWeight(0);
    stroke(0);
    fill(0);
    textAlign(LEFT);
    textSize(20);
    text(gPlayerNameTxt, 10, height - 25);
    
    // section and instrument names
    if (!gInstEnabled) {
      stroke(150);
      fill(150);
    }
    textAlign(CENTER);
    textSize(32);
    text(gSectionNameTxt + ': ' + gInstNameTxt, width/2, 30);

    // ui draw
    if (utl.supportsTouch())
      ui.draw(touchX, touchY);
    else
      ui.draw(mouseX, mouseY);
  }

  function btnCB(name, value) {
    utl.print('button ' + name + ': ' + value);
  }

    gotoPage(1);

  </script>
</body>
</html> 
